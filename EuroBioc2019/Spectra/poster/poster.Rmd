---
title: "Flexible Infrastructure for Mass Spectrometry Data"
author:
  - name: Laurent Gatto
    affil: 1
    orcid: "0000-0002-1520-2268"
  - name: Johannes Rainer
    affil: 2
    orcid: "0000-0002-6977-7147"
  - name: Sebastian Gibb
    affil: 3
    orcid: "0000-0001-7406-4443"
affiliation:
  - num: 1
    address: Computational Biology and Bioinformatics Group, de Duve Institute, UCLouvain
  - num: 2
    address: Institute for Biomedicine, Eurac Research
  - num: 3
    address: Department of Anaesthesiology and Intensive Care, University Medicine Greifswald
poster_width: "841mm"
poster_height: "1189mm"
primary_colour: "#2574A9"
column_numbers: 2
logoleft_name: https&#58;//raw.githubusercontent.com/rformassspectrometry/stickers/master/Spectra/Spectra.png
logoright_name: https&#58;//raw.githubusercontent.com/rformassspectrometry/stickers/master/logo/R4MassSpec-logo.png
bibliography:
  - rpackages.bib
link-citations: false
csl: nature.csl
output:
  posterdown::posterdown_html:
    self_contained: false
---

```{r environment, results = FALSE, echo = FALSE, message = FALSE, warning = FALSE}
Sys.setenv(LANGUAGE = "en")
library("Spectra")

# BiocManager::install("rformassspectrometry/MsBackendHmdb")
library("MsBackendHmdb")

# sudo su apt install mono-devel nuget
# BiocManager::install("cpanse/MsBackendRawFileReader@Bioc3.10")
library("MsBackendRawFileReader")

bkdPkgs <- c("Spectra", "MsBackendHmdb", "MsBackendRawFileReader")
```

```{r citations, results = FALSE, echo = FALSE, message = FALSE, warning = FALSE}
packagesToCite <- bkdPkgs
bib <- unlist(lapply(packagesToCite, function(x)toBibtex(citation(x))))
bib[grepl("Manual\\{", bib)] <- paste0("@Manual{", packagesToCite, ",")
writeLines(bib, "rpackages.bib")
```

```{r pkgcontent, echo = FALSE, message = FALSE, warning = FALSE}
pkgContent <- lapply(paste0("package:", bkdPkgs), function(pkg) {
    content <- ls(pkg)
    content[grep("MsBackend.+", content)]
})
names(pkgContent) <- bkdPkgs
backendClassNames <- unlist(pkgContent)
backendClasses <- lapply(backendClassNames, new)
```

# Introduction

## Mass Spectrometry (MS) Data

- Paired measurements:
    - intensity (counts) vs *m/z* (mass-to-charge ratio).
    - intensity vs retention time.

- Additional various metatdata.

## Problems

- Vendor-specific, closed file formats.
- Various open-formats, e.g. mzML, mzXML, mz5, CDF, MGF, CSV
- Spectra libraries/Annotation information in databases, e.g. SQL
- Multiple R-packages require different file formats and/or data structures.
- Larger experiments don't fit into RAM.

## Solution: `Spectra`[@Spectra]

- Common, flexible data structure and interface.
- Supports various file formats by different backends.

# Implementation Details

## `Spectra` class

- Handles one or multiple MS spectra.
- Implements typical processing functionality.
- Isolation from type of data storage (handled by backend classes)

## `MsBackend` classes

- Isolation from spectra handling and processing.
- Specific class for each type of data storage.

```{r backendtable, echo = FALSE}
src <- c(
    MsBackendDataFrame = "manual",
    MsBackendHdf5Peaks = "hdf5 files",
    MsBackendMzR = "mzML, mzXML and CDF files",
    MsBackendHmdbXml = "XML files",
    MsBackendRawFileReader = "Thermo .raw files"
)
classTbl <- data.frame(
    class = paste0(backendClassNames,
        "[@", gsub("[^A-z]", "", names(backendClassNames)), "]"
    ),
    source = src[backendClassNames],
    storage = ifelse(
        grepl("DataFrame", backendClassNames), "in-memory", "on-disk"
    ),
    writeable = ifelse(!sapply(backendClasses, isReadOnly), "yes", "no")
)

knitr::kable(classTbl, row.names = FALSE)
```

![The user interacts with a `Spectra` object. It takes care of the data storage by different backend classes.](images/Backends_03.png){width=75%}

# Example

```{r example}
# Load packages
library(Spectra)
library(magrittr)

# Import data
#sps <- Spectra("data/20191107_Mix2_CE20.mzML", backend = MsBackendMzR())
sps <- Spectra()

# Select all MS2 spectra for a [M+Na]+ ion of Fructose.

mzr <- 203.0526
mzr <- 156.07675 # Histidine
fruct <- sps %>%
    filterMsLevel(2) %>%
    filterPrecursorMz(mz = mzr + ppm(c(-mzr, mzr), 20))

# Centroid and clean spectra.

fruct <- fruct %>%
    pickPeaks() %>%
    removePeaks(threshold = 500) %>%
    clean(all = TRUE)

# Change backend: load data in memory.

#fruct <- setBackend(fruct, MsBackendDataFrame())
```

# Contact

- <i class="fab fa-github"></i> [rformassspectrometry/Spectra](https://github.com/rformassspectrometry/Spectra)
- <i class="fas fa-home"></i> [rformassspectrometry.org](https://rformassspectrometry.org)
- <i class="fab fa-twitter"></i> [#RforMassSpec](https://twitter.com/search?q=%23rformassspec)

# References
